<!DOCTYPE html> 
<html lang="de">
	<head>
		<title>WordClock - Lua</title>
		<meta charset="utf-8">
		<meta name="robots" content="noindex, nofollow">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		
		<link rel="stylesheet" href="http://cdn.jsdelivr.net/bootstrap/3.3.6/css/bootstrap.min.css" type="text/css">
				
		<script src="http://cdn.jsdelivr.net/g/jquery@1.12.4,bootstrap@3.3.6"></script>
		<script src="http://cdn.jsdelivr.net/ace/1.2.3/min/ace.js"></script>
		
		<!--[if lt IE 9]><script src="http://cdn.jsdelivr.net/g/html5shiv@3.7.2,respond@1.4.2"></script><![endif]-->
		
		<script type="text/javascript">
			jQuery(document).ready(function($) {
				function openWs() {
					var connection = new WebSocket('ws://'+location.hostname+':8080/lua-log', []);
					
					connection.onmessage = function(e) {
						$('#log').prepend(e.data.trim().split("\n").reverse().map(function(t) { return "<span>"+t+"<br></span>"; }).join(""));
						while($('#log span').size() > 50) {
							$('#log span:last').remove();
						}
					};
					
					connection.onopen = function() {
						$('div.row').stop().fadeTo(500, 1);
					}
					
					connection.onclose = openWsDelay;
				}
				
				function openWsDelay(e) {
					$('div.row').stop().fadeTo(500, 0.3);
					setTimeout(function() {
						openWs();
					}, 2000);
				};
				
				openWs();
				
				var editor = ace.edit("editor");
				editor.getSession().setMode("ace/mode/lua");
				editor.setOption('maxLines',Infinity);
				editor.$blockScrolling = Infinity;
				editor.on('change', function() {
					changed = true;
				});
				
				var changed = false;
				
				function getLua() {
					$.ajax({
						url: 'http://'+location.hostname+':8080/lua',
						type: 'GET',
						success: function(result) {
							editor.setValue(result, -1);
							changed = false;
						},
						error: function() {
							setTimeout(getLua, 1000);
						}
					});
				}
				getLua();
				
				$(window).on('beforeunload', function() {
					if(changed) return 'Discard changes?';
				});
				
				
				$('#save').click(function() {
					$.ajax({
						url: 'http://'+location.hostname+':8080/lua',
						type: 'PUT',
						data: editor.getValue(),
						success: function(result) {
							changed = false;
							alert('true');
						},
						error: function(result) {
							alert(result.responseText);
						}
					});
				});
				$('#load').click(function() {
					if(!changed || confirm('Discard changes?')) {
						getLua();
					}
				});
				
				$('#export').click(function() {
					$(this).attr('href','data:application/octet-stream,' + encodeURIComponent(editor.getValue()));
				});
				$('#import').click(function() {
					$('#import_file').click();
				});
				
				// http://stackoverflow.com/questions/10261989/html5-javascript-drag-and-drop-file-from-external-window-windows-explorer
				var dropZone = $('body')[0];
				dropZone.addEventListener('dragover', function(e) {
					e.stopPropagation();
					e.preventDefault();
					e.dataTransfer.dropEffect = 'copy';
				});
				dropZone.addEventListener('drop', function(e) {
					e.stopPropagation();
					e.preventDefault();
					readFiles(e.dataTransfer.files);
				});
				
				$('#import_file').change(function(e) {
					readFiles(e.target.files);
					$('#file_form')[0].reset();
				});
				
				function readFiles(files) {
					for (var i = 0, f; file = files[i]; i++) {
						var reader = new FileReader();
						reader.onload = function(e2) { // finished reading file data.
							editor.setValue(e2.target.result, -1);
						}
						reader.readAsBinaryString(file); // start reading the file data.
						changed = true;
					}
				}
			});
		</script>
	</head>

	<body>
		<form class="hidden" action="" id="file_form">
			<input type="file" id="import_file">
		</form>
		<div class="container">
			<h1 class="page-header"><span class="glyphicon glyphicon-console"></span> Lua</h1>
			
			<ol class="breadcrumb">
				<li><a href="/">Home</a></li>
				<li class="active">Lua</li>
			</ol>
			
			<div class="row">
				<div class="col-xs-12">
					<div class="panel panel-default">
						<div class="panel-heading">
							<h3 class="panel-title"><span class="glyphicon glyphicon-align-justify"></span> Log</h3>
						</div>
						<div class="panel-body">
							<pre style="height: 200px;" id="log"></pre>
						</div>
					</div>
				</div>
			</div>
			
			<div class="row">
				<div class="col-xs-12">
				
					<div class="panel panel-default">
						<div class="panel-heading">
							<h3 class="panel-title"><span class="glyphicon glyphicon-cog"></span> Actions</h3>
						</div>
						<div class="panel-body">
							<div class="btn-group" role="group">
								<button id="save" type="button" class="btn btn-primary"><span class="glyphicon glyphicon-save"></span> Save</button>
								<button id="load" type="button" class="btn btn-default"><span class="glyphicon glyphicon-open"></span> Load</button>
							</div>
							<div class="btn-group" role="group">
								<a href="#" download="script.lua" id="export" class="btn btn-default"><span class="glyphicon glyphicon-export"></span> Export</a>
								<a href="#" id="import" class="btn btn-default"><span class="glyphicon glyphicon-import"></span> Import</a>
							</div>
						</div>
					</div>
				</div>
			</div>
			
			<div class="row">
				<div class="col-xs-12">
					<div class="panel panel-default">
						<div class="panel-heading">
							<h3 class="panel-title"><span class="glyphicon glyphicon-pencil"></span> Editor</h3>
						</div>
						<div class="panel-body">
							<div style="min-height: 300px; width: 100%;" id="editor"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>
